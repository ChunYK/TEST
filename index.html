<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸­å›½æ‰‹åŠ¿è¯†åˆ«ç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh; 
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        .input_video {
            position: absolute;
            width: 1px; height: 1px;
            opacity: 0; pointer-events: none;
        }

        #number-display {
            font-size: 40vw;
            font-weight: 700;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            cursor: default;
        }

        #number-display.active {
            opacity: 1;
            transform: scale(1);
        }

        #loading {
            position: absolute; bottom: 50px;
            font-size: 14px; color: #666;
            text-align: center; width: 100%;
            animation: pulse 1.5s infinite;
        }
        
        #mode-hint {
            position: absolute; top: 20px;
            font-size: 12px; color: #444;
            background: rgba(255,255,255,0.1);
            padding: 5px 10px; border-radius: 20px;
        }

        @keyframes pulse { 0% {opacity:0.4} 50% {opacity:1} 100% {opacity:0.4} }
    </style>
</head>
<body>

    <video class="input_video" playsinline webkit-playsinline muted autoplay></video>

    <div id="mode-hint">æ”¯æŒä¸­å›½å•æ‰‹æ‰‹åŠ¿ (6-9)</div>
    <div id="number-display"></div>
    <div id="loading">æ­£åœ¨åŠ è½½ç¥ç»ç½‘ç»œ...</div>

    <script>
        const videoElement = document.getElementsByClassName('input_video')[0];
        const displayElement = document.getElementById('number-display');
        const loadingElement = document.getElementById('loading');
        
        let lastNumber = -1;

        function onResults(results) {
            if(loadingElement.style.display !== 'none') loadingElement.style.display = 'none';

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                
                let finalNumber = 0;

                // ç­–ç•¥åˆ†æ”¯ï¼šå•æ‰‹ vs åŒæ‰‹
                if (results.multiHandLandmarks.length === 1) {
                    // === å•æ‰‹æ¨¡å¼ï¼šå¯ç”¨ä¸­å›½æ‰‹åŠ¿é€»è¾‘ ===
                    const landmarks = results.multiHandLandmarks[0];
                    const handedness = results.multiHandedness[0].label;
                    finalNumber = detectChineseGesture(landmarks, handedness);
                } else {
                    // === åŒæ‰‹æ¨¡å¼ï¼šç®€å•ç´¯åŠ  ===
                    // åŒæ‰‹æ—¶ï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œæˆ‘ä»¬åªè®¡ç®—ä¼¸å‡ºçš„æ‰‹æŒ‡æ€»æ•°
                    // æ¯”å¦‚å·¦æ‰‹æ¯”"å…«"(2æŒ‡) + å³æ‰‹æ¯”"äºŒ"(2æŒ‡) = æ˜¾ç¤º 4ï¼Œè€Œä¸æ˜¯ 8+2
                    // è¿™æ ·ç¬¦åˆäººç±»ç›´è§‰ï¼šåŒæ‰‹æ˜¯ä¸ºäº†å‡‘æ•°
                    for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                        finalNumber += countBasicFingers(results.multiHandLandmarks[i], results.multiHandedness[i].label);
                    }
                }
                
                updateDisplay(finalNumber);

            } else {
                hideDisplay();
            }
        }

        // === æ ¸å¿ƒï¼šä¸­å›½æ‰‹åŠ¿è¯†åˆ«å™¨ ===
        function detectChineseGesture(landmarks, handLabel) {
            // 1. è·å–äº”ä¸ªæ‰‹æŒ‡çš„çŠ¶æ€ (true=ä¼¸å‡º, false=å¼¯æ›²)
            const f = getFingerStates(landmarks, handLabel);
            
            // f[0]=æ‹‡æŒ‡, f[1]=é£ŸæŒ‡, f[2]=ä¸­æŒ‡, f[3]=æ— åæŒ‡, f[4]=å°æŒ‡

            // åŸºç¡€æ•°é‡ (æœ‰å¤šå°‘æ ¹æ‰‹æŒ‡ä¼¸å‡ºæ¥äº†)
            const basicCount = f.filter(Boolean).length;

            // --- ç‰¹æ®Šä¸­å›½æ•°å­—é€»è¾‘ ---

            // è¯†åˆ« 6: ğŸ¤™ (æ‹‡æŒ‡ + å°æŒ‡)
            // é€»è¾‘: æ‹‡æŒ‡å°æŒ‡ä¼¸å‡ºï¼Œä¸­é—´ä¸‰æŒ‡å¼¯æ›²
            if (f[0] && f[4] && !f[1] && !f[2] && !f[3]) return 6;

            // è¯†åˆ« 8: ğŸ‘† (æ‹‡æŒ‡ + é£ŸæŒ‡) - ä¿—ç§°æ‰‹æªæˆ–è€…å…«
            // é€»è¾‘: æ‹‡æŒ‡é£ŸæŒ‡ä¼¸å‡ºï¼Œå…¶ä»–ä¸‰æŒ‡å¼¯æ›²
            if (f[0] && f[1] && !f[2] && !f[3] && !f[4]) return 8;

            // è¯†åˆ« 7: ææŒ‡ æˆ– æ‹‡æŒ‡+é£ŸæŒ‡+ä¸­æŒ‡
            // å¾ˆå¤šä¸­å›½äººæ¯”7æ˜¯æåœ¨ä¸€èµ·ï¼Œæˆ–è€…ä¸‰æŒ‡ä¼¸å‡ºã€‚
            // é€»è¾‘: æ‹‡æŒ‡+é£ŸæŒ‡+ä¸­æŒ‡ä¼¸å‡ºï¼Œæ— åæŒ‡å°æŒ‡å¼¯æ›²
            if (f[0] && f[1] && f[2] && !f[3] && !f[4]) return 7;

            // è¯†åˆ« 9: â˜ï¸ (é£ŸæŒ‡é’©å­)
            // é€»è¾‘: è¿™æ˜¯ä¸€ä¸ªéš¾ç‚¹ã€‚é€šå¸¸çœ‹èµ·æ¥åƒæ¡æ‹³(0)æˆ–è€…æŒ‡å¾—åƒ1ã€‚
            // è¿™é‡Œçš„åˆ¤å®šè§„åˆ™ï¼šé£ŸæŒ‡çš„æŒ‡å°–(8)ä½äºæŒ‡å…³èŠ‚(6)ï¼Œä½†æ˜¯æŒ‡å…³èŠ‚(6)æ˜æ˜¾é«˜äºæŒå…³èŠ‚(5)ã€‚
            // ä¸”å…¶ä»–æ‰‹æŒ‡æ˜¯å¼¯æ›²çš„ã€‚
            if (!f[1] && !f[2] && !f[3] && !f[4]) {
                // å¦‚æœåŸºæœ¬åˆ¤å®šå…¨æ˜¯å¼¯æ›²çš„ï¼ˆåƒæ‹³å¤´ï¼‰ï¼Œæ£€æŸ¥é£ŸæŒ‡æ˜¯ä¸æ˜¯â€œé’©â€ç€çš„
                const indexPipY = landmarks[6].y; // ç¬¬äºŒå…³èŠ‚
                const indexMcpY = landmarks[5].y; // æ ¹éƒ¨å…³èŠ‚
                const indexTipY = landmarks[8].y; // æŒ‡å°–

                // å¦‚æœé£ŸæŒ‡ç¬¬äºŒå…³èŠ‚ æ˜æ˜¾é«˜äº æ ¹éƒ¨ (æ³¨æ„Yè½´å‘ä¸‹ä¸ºæ­£ï¼Œæ‰€ä»¥æ˜¯ < )
                // å¹¶ä¸”æŒ‡å°– ä½äº ç¬¬äºŒå…³èŠ‚ (å¼¯ä¸‹æ¥äº†)
                // *å¢åŠ ä¸€ä¸ªé˜ˆå€¼åˆ¤æ–­ï¼Œé˜²æ­¢è¯¯è§¦*
                if (indexPipY < indexMcpY && indexTipY > indexPipY) {
                    // å†æ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯åªæœ‰é£ŸæŒ‡åœ¨åŠ¨ä½œï¼Œå…¶ä»–æ‰‹æŒ‡å¿…é¡»æ”¶ç´§
                    return 9;
                }
            }

            // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ç‰¹æ®Šæ‰‹åŠ¿ï¼Œå°±è¿”å›åŸºç¡€æ•°é‡ (0-5)
            return basicCount;
        }

        // è¾…åŠ©ï¼šè·å–äº”æŒ‡çŠ¶æ€ [æ‹‡æŒ‡, é£ŸæŒ‡, ä¸­æŒ‡, æ— åæŒ‡, å°æŒ‡]
        function getFingerStates(landmarks, handLabel) {
            let states = [false, false, false, false, false];
            
            // æ£€æŸ¥é£ŸæŒ‡(1) åˆ° å°æŒ‡(4)
            const tipsIds = [8, 12, 16, 20];
            const pipIds = [6, 10, 14, 18];
            for (let i = 0; i < 4; i++) {
                // æŒ‡å°– Y < å…³èŠ‚ Y è¡¨ç¤ºä¼¸å‡º (åæ ‡åŸç‚¹åœ¨å·¦ä¸Šè§’)
                if (landmarks[tipsIds[i]].y < landmarks[pipIds[i]].y) {
                    states[i+1] = true;
                }
            }

            // æ£€æŸ¥æ‹‡æŒ‡(0) - ä¾èµ– X è½´
            const thumbTip = landmarks[4].x;
            const thumbIP = landmarks[3].x;
            if (handLabel === 'Right') { // ç”»é¢å·¦ä¾§
                if (thumbTip < thumbIP) states[0] = true;
            } else { // ç”»é¢å³ä¾§
                if (thumbTip > thumbIP) states[0] = true;
            }

            return states;
        }

        // è¾…åŠ©ï¼šä»…è®¡ç®—ä¼¸å‡ºçš„æ‰‹æŒ‡æ•°é‡ (ç”¨äºåŒæ‰‹æ¨¡å¼)
        function countBasicFingers(landmarks, handLabel) {
            const states = getFingerStates(landmarks, handLabel);
            return states.filter(Boolean).length;
        }

        // --- UI æ›´æ–°é€»è¾‘ (ä¸å˜) ---
        function updateDisplay(number) {
            if (number !== lastNumber) {
                lastNumber = number;
                displayElement.innerText = number;
                displayElement.classList.add('active');
            }
            if (!displayElement.classList.contains('active')) displayElement.classList.add('active');
        }

        function hideDisplay() {
            displayElement.classList.remove('active');
            setTimeout(() => {
                if(!displayElement.classList.contains('active')) lastNumber = -1;
            }, 350);
        }

        // --- åˆå§‹åŒ– (ä¸å˜) ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 2, 
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => await hands.send({image: videoElement}),
            width: 1280, height: 720, facingMode: 'user'
        });
        camera.start();
    </script>
</body>
</html>
